generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  name       String
  username   String    @unique
  avatar     String?
  coverImage String?
  bio        String?
  birthDate  DateTime?       
  gender     Gender?         
  location   String?         
  createdAt  DateTime  @default(now())
  helpfuls   Helpful[]

  // Role
  role UserRole @default(USER)

  // Relacionamentos
  reviews    Review[]
  lists      List[]
  savedMedia Media[]  @relation("SavedMedia")
  favorites  Media[]  @relation("Favorites")
  excludedMedia      UserExcludedMedia[]
  recommendationEngagements RecommendationEngagement[]
  initialPreferences UserInitialPreference[]

  // Configurações de privacidade
  profileVisibility String             @default("public")
  showActivity      Boolean            @default(true)
  showSavedItems    Boolean            @default(true)
  showFavorites     Boolean            @default(true)
  showReviews       Boolean            @default(true)
  showStats         Boolean            @default(true)
  dataCollection    Boolean            @default(true)
  PasswordRecovery  PasswordRecovery[]
}

model Media {
  id             Int                   @id @default(autoincrement())
  title          String
  rating         Float
  image          String?
  description    String?
  year           Int
  type           MediaType
  classification ClassificationRating?
  reviewCount    Int?                  @default(0)
  createdAt DateTime @default(now())

  // Relacionamentos
  genres             String[]
  streamingLinks     StreamingLink[]
  reviews            Review[]
  savedBy            User[]             @relation("SavedMedia")
  favoritedBy        User[]             @relation("Favorites")
  lists              List[]
  excludedBy         UserExcludedMedia[]
  recommendationEngagements RecommendationEngagement[]
  initialPreferences UserInitialPreference[]

  // Campos opcionais específicos
  artists   String[]
  directors String[]
  platforms String[]
  authors   String[]
  seasons   Int?
  duration  Int?
  tracks    Int?
  pages     Int?
  publisher String?
  developer String?
  cast      String[] @default([])
  awards    String[] @default([])

  @@unique([title, type])
}

model Review {
  id       Int       @id @default(autoincrement())
  rating   Float
  comment  String
  date     DateTime  @default(now())
  helpful  Int       @default(0)       // contador de "úteis"
  helpfuls Helpful[]

  media   Media @relation(fields: [mediaId], references: [id])
  mediaId Int
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  Int

  @@unique([userId, mediaId]) // <- índice único combinando usuário + mídia
}

model List {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int
  items  Media[]
}

model StreamingLink {
  id      Int    @id @default(autoincrement())
  service String
  url     String
  mediaId Int
  media   Media  @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([mediaId, service])
}

model Helpful {
  id       Int    @id @default(autoincrement())
  userId   Int
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewId Int
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([userId, reviewId])
}

model PasswordRecovery {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false) // adiciona campo usado
  createdAt DateTime @default(now())

  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RecommendationEngagement {
  id        Int      @id @default(autoincrement())
  userId    Int
  mediaId   Int
  action    String   // 'page_view', 'saved', 'favorited', etc.
  score     Float
  timestamp DateTime @default(now())
  metadata  Json?

  user User @relation(fields: [userId], references: [id])
  media Media @relation(fields: [mediaId], references: [id])

  @@index([userId])
  @@index([mediaId])
  @@index([timestamp])
}

model UserExcludedMedia {
  id        Int      @id @default(autoincrement())
  userId    Int
  mediaId   Int
  expireAt  DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  media     Media    @relation(fields: [mediaId], references: [id])

  @@unique([userId, mediaId])
}

model UserInitialPreference {
  id      Int    @id @default(autoincrement())
  userId  Int
  mediaId Int

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id])

  @@unique([userId, mediaId])
}

enum UserRole {
  USER
  ADMIN
}

enum MediaType {
  MOVIE
  GAME
  MUSIC
  SERIES
  BOOK
}

enum ClassificationRating {
  L
  TEN
  TWELVE
  FOURTEEN
  SIXTEEN
  EIGHTEEN
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NONE
}